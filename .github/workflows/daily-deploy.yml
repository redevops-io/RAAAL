name: Daily Backtest & Deploy

on:
  schedule:
    # Run at 6 AM UTC every day (1 AM EST, 2 AM EDT)
    - cron: '0 6 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
  
  # Run on push to main
  push:
    branches:
      - main

jobs:
  backtest-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Force the workflow to run off the canonical main branch so the
          # resulting Pages deployment goes to the production environment.
          ref: main
      
      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run historical backtest
        run: |
          python -m src.history \
            --start 2016-01-01 \
            --end $(date +%Y-%m-%d) \
            --refresh
      
      - name: Build dashboard
        run: |
          echo "Building dashboard from historical data..."
          python -m src.visualization.bokeh_app
          echo "Dashboard build completed"
          ls -lh reports/regime_dashboard.html
          cp reports/regime_dashboard.html reports/index.html
          echo "Dashboard files ready for deployment:"
          ls -lh reports/*.html
      
      - name: Verify data freshness
        run: |
          python -c "
          import pandas as pd
          from pathlib import Path
          prices = pd.read_parquet('data/history/prices.parquet')
          timeline = pd.read_parquet('data/history/timeline.parquet')
          print(f'Price data range: {prices.index.min().date()} to {prices.index.max().date()}')
          print(f'Timeline range: {timeline.index.min().date()} to {timeline.index.max().date()}')
          print(f'Dashboard size: {Path(\"reports/regime_dashboard.html\").stat().st_size / 1024 / 1024:.2f} MB')
          "
      
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: raaal-dashboard
          directory: reports
          branch: main
      
      - name: Upload dashboard artifact
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-${{ github.sha }}
          path: reports/regime_dashboard.html
          retention-days: 30

