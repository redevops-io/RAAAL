name: Daily Backtest & Deploy

on:
  schedule:
    # Run at 6 AM UTC every day (1 AM EST, 2 AM EDT)
    - cron: '0 6 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
  
  # Run on push to master
  push:
    branches:
      - master
      - main

jobs:
  backtest-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run historical backtest
        run: |
          python -m src.history \
            --start 2016-01-01 \
            --end $(date +%Y-%m-%d) \
            --refresh
      
      - name: Build dashboard
        run: |
          python -m src.visualization.bokeh_app
      
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: raaal-dashboard
          directory: reports
      
      - name: Upload dashboard artifact
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-${{ github.sha }}
          path: reports/regime_dashboard.html
          retention-days: 30
